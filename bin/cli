#!/usr/bin/env node

const fs = require('fs-extra')
const path = require('path')
const { exec } = require('../lib/exec')

const installDirectory = process.cwd()
const kitRoot = path.join(__dirname, '..')

const copyFile = (fileName) => fs.copy(path.join(kitRoot, fileName), path.join(installDirectory, fileName))
const command = process.argv[2]
const option = process.argv[3]

const npmrc = `
audit=false
script-shell=bash
`

const gitignore = `
# Node.js ignores
node_modules/

# Prototype ignores - per-user
.env
public/

# General ignores
.DS_Store
.idea
`

function usage () {
  const prog = 'npx govuk-prototype-kit'
  console.log(`
${prog} <command>

Usage:

${prog} install
${prog} start`
  )
}

;(async () => {
  if (command === 'install') {
    await Promise.all([
      fs.copy(path.join(kitRoot, 'prototype-starter'), installDirectory),
      fs.writeFile(path.join(installDirectory, '.gitignore'), gitignore, 'utf8'),
      fs.writeFile(path.join(installDirectory, '.npmrc'), npmrc, 'utf8'),
      copyFile('LICENCE.txt')
    ])

    let kitDependency = 'govuk-prototype-kit'

    if (option === 'local') {
      kitDependency = kitRoot
    } else if (option.match(/\d+\.\d+\.\d+/)) {
      kitDependency = `govuk-prototype-kit@${option}`
    } else if (option) {
      kitDependency = option
    }

    console.log('Installing the kit')
    const dots = setInterval(() => {
      process.stdout.write('.');
    }, 500)
    await exec(`npm install ${kitDependency} govuk-frontend`, { stdio: 'inherit' }, console.log)
    clearInterval(dots)
    
  } else if (command === 'start') {
    require('../start')
  } else {
    usage()
    process.exitCode = 2
  }
})()
